---
title: 仿网易云音乐遇到的坑
date: 2020-05-21 13:57:58
categories: 前端项目
tags: ['jquery','js','leancloud']
---

接近一个月没写博客了，这段时间主要在练习一个小项目-[仿网易云音乐](http://caijd.top/163music/src/index.html)。这个项目使用**原生JS和jquery**构建，支持移动端,支持歌单、最新和最热歌曲点播，播放页支持歌词。后台通过leancloud 提供的API搭建。通过这个小项目，我对前后端交互有了更深刻的认识。同时对**MVC和OOP思想**也有了自己的理解。今天我对这段时间学到的新知识和遇到的一些BUG记录下来，以便以后借鉴。

## safari浏览器中的奇怪行为
1. 在safari中不能**使用js在body中**动态添加`background-image:url()`。否则会出现body背景图片显示不全的BUG。而其他的浏览器目前没有发现这个问题。
**解决方法：**可以在body中新建一个`div`元素专门用来作为`background-image`的容器

---

2. safari暂时不支持`image/webp`图片格式
现在很多公司为了优化web性能，网页图片都使用google定义的image/webp图片标准。目前chrome、firefox等主流的浏览器都支持它，但safari和IE由于各种原因暂时不支持image/webp。当我们使用webp图片时就会出现图片不显示的问提。所以我们在使用webp之前需要进行浏览器功能检查。

方法1：尝试加载一张WebP图片，观察是否能够正常加载 
```
{
    let WebP = new Image();
    WebP.onload = ()=>{     //支持webp       }    
    WebP.onerror = ()=>{    //不支持webp     }
    WebP.src = '图片url'
}
```
方法2：通过canvas中特性来判断
`document.createElement('canvas').toDataURL('image/webp',0.5).indexOf('data:image/webp') === 0`
canvas.toDataURL()默认输出**image/png**格式，当支持webp时，上面的表达式输出**image/webp**

---

## 事件中心eventHub和url查询参数
前端一直在朝着模块化的方向发展，模块的一个功能就是封装方法和属性。那么模块间的数据传递就是摆在我们的眼前的一个难题。模块数据传递目前分为同一页面的数据传递和不同页面的数据传递。
### 同一页面数据的传递
如果多个模块在同一个页面，那么我们可以利用**事件中心eventHub**，通过**发布（emit）和订阅（on）**思想来实现数据的传递。
```
window.eventHub = {
  events: {},
  emit(event,data){
    if(this.events[event] && this.events[event].length){
      this.events[event].forEach((fn)=>{
        fn.call(null,data) 
      })
    }
  },
  on(event,fn){
    if(Array.isArray(event)){
      event.forEach((item)=>{
        this.events[item] = this.events[item] || []
        this.events[item].push(fn)
      })
    }else{
      this.events[event] = this.events[event] || []
      this.events[event].push(fn)
    }
  }
}
```

---

### 不同页面间的数据传递
当多个模块不在同一页面时，eventHub没有了全局的基础，这时候我们可以通过**http请求URL的query参数**(?id=1111&name=cai)来实现数据的传递。或者使用更高级的**cookie ,sessionID以及localStorage**。
