---
title: 浏览器同源策略与跨域
date: 2020-04-19 22:27:25
categories: 前端
tags: ['浏览器','CORS','JSONP','同源','ajax']
---
## 同源策略
只有**协议、域名和端口号完全一致**的两个网站，才可以资源共享。其中受限制的行为包括：
1. AJAX 请求不能发送。（发送了得不到响应）
2. Cookie、LocalStorage 和 IndexDB 无法读取。
3. DOM 无法获得

同源策略的目的，是为了保证用户信息的安全。

---
## JSONP
### HTML可以发送请求的元素
1. form表单和a标签(都会刷新页面,体验不好)
```
<form method='get' action='/path' target=''></form>     //将target指向特定的iframe可以间接消除浏览器刷新
<a href='/path'></a>
```
2. img/link元素
```
let img = document.createElement('img')
img.src = '/path'
img.onload = ()=>{ ...codeBlock }   //必须返回一个图片才会onload
img.onerror = ()=>{ ...codeBlock }
```
3. script元素
![server rendered javascript](/images/SRJ.png)
```
let script = document.createElement('script')
script.src = '/path'
document.body.appendChild('script') //必须将script加入到dom中，请求才生效
script.onload = (e)=>{ ...codeBlock e.currentTarget.remove() }   //先执行服务器返回文本再执行onload回调
script.onerror = ()=>{ ...codeBlock }
```
---
### JSONP（json with padding）
如同上面方法3，JSONP基本思想是,**动态添加一个script元素**，向服务器请求数据，这种做法不受同源政策限制；服务器收到请求后，将数据放在一个指定名字的回调函数里传回来。
![jsonp小结](/images/jsonp.png)
---
#### jsonp注意点
1. jsonp只能使用get请求
2. jsonp中script标签src传入的查询参数约定为`?callback=funcName`,其中funcName由字母和**随机数**构成
3. 服务器通过**回调函数的参数**给浏览器传递任意数据
---
## AJAX（async javascript and XML）和 CORS(cross-origi resource sharing)
早期的前端只能发送简单的get请求。IE 5率先在 JS 中引入**ActiveX**对象，使得 JS 可以直接发起 HTTP 请求（get post put delete）。随后 Mozilla、 Safari、 Opera 也跟进引入了**XMLHttpRequest**对象，最后**XMLHttpRequest**对象被纳入 W3C 规范。
```
<!-- 前端代码 -->
let xhr = new XMLHttpRequest()
xhr.open('post','www.baidu.com')        // 打开xhr ，并设置mehtod 和 path
xhr.setRequestHeader('content-type','text/javascript;charset=utf8') //设置请求头
xhr.onreadystatechange = (e)=>{
    if(xhr.readystate === 4){
        if(xhr.status >=200 && xhr.status <300){
            console.log('请求成功！')
            let response = xhr.responseText //获取响应字符串
            let json = JSON.parse(response) //将字符串转化为js对象
            ...
        }
        else if(xhr.status >=400){
            console.log('请求失败！')
        }
    }
}
xhr.send()      //添加参数可以设置request body



<!-- 后端代码 -->
if(path === '/path'){
    response.statusCode = 200
    response.setHeader('Content-Type','text/json;charset=utf-8')
    response.setHeader('Access-Control-Allow-Origin','http://www.baidu.com:8080')       //CORS
    response.setHeader('Access-Control-Allow-Origin','*')   //CORS
    response.write(
        `{
            "a": 1,
            "b": 2
        }
        `
    )    
    response.end()
}
```

---
### AJAX常用的API
|API| usage|
|--:--|--:--|
|xhr.readystate|0-close、1-open、 2-send and receive responseHeader responseStatus、3-download and loading、 4-completed  |
|xhr.status|状态码 200 400 |
|xhr.statusText|状态码文本 ok |
|xhr.responseText|响应 |
|xhr.getAllResponseHeaders()|获取所有的响应头 |
|xhr.getAllResponseHeader('')|获取响应头 |
|xhr.setRequestHeader('')|设置请求头 |
|JSON.parse('')|string to json |
|JSON.stringify(obj)|json to string |

---
### CORS
由于AJAX存在**同源限制**，所以出现了CORS。CORS就是在服务器端加上响应头。
```
response.setHeader("Access-Control-Allow-Origin",path)
```


