---
title: 浏览器输入URL到页面显示全过程
date: 2020-04-19 13:05:17
categories: 前端
tags: ['http','浏览器']
---

## 浏览器从URL到页面显示的过程
![浏览器http请求过程](/images/browser.png)
1. 域名解析，返回IP
2. 发起TCP的3次握手，建立TCP连接
3. 浏览器发起http请求，服务器响应htp请求
4. 浏览器解析html代码,并请求html代码中的资源(如js、css、图片等）
5. 4次挥手,断开TCP连接
6. 浏览器对渲染页面呈现给用户

### 域名解析
域名解析包括**本地DNS缓存查询和远程DNS查询**。

本地缓存查询按照浏览器DNS缓存 → 操作系统DNS缓存 → HOSTS文件的顺序依次查找，如果没有找到对应的IP，再进行远程DNS查询。
远程DNS查询首先在本地域名服务器（网络接入商提供）缓存上查询，如果没有结果再依次按照根域名服务器 → 顶级域名服务器（.com顶级域名） → 权威域名服务器(二级域名和三级域名)的顺序依次查询，并**将IP依次返回给本地域名服务器、操作系统和浏览器**。

### TCP连接
#### 三次握手建立连接
![tcp三次握手](/images/tcp_connect.png)

|FLAGS|meaning|
|--:------|--:--------|
|SYN|synchronous 表示请求建立连接，并在其序列号的字段进行序列号的初始值设定。建立连接，一般设置为1|
|seq|sequence 随机序列码|
|ACK|Acknowledgement 确认，表示响应|
|ACKFLAG|确认标志，一般设为1|
|ACKNumber| 确认号码，表示期待下一次接受的包序号|
|PSH|push 推送，提示接收端应用程序立即从TCP缓冲区把数据读走|
|FIN|finish 完成，希望断开连接|
|RST|reset 复位，对方要求重新建立连接|
|URG|urgent 紧急指针是否有效。为1，表示某一位需要被优先处理|


在TCP/IP协议中，TCP协议提供可靠的连接服务，采用三次握手建立一个连接。
第一次握手：建立连接时，客户端发送**SYN包**(**SYN=1**)到服务器，客户端把这段连接的序号**seq设定为随机数x**,进入**SYN_SEND**状态，等待服务器确认；
第二次握手：服务器端应当为一个合法的SYN回送一个**SYN/ACK**。ACK的确认码**ACKFLAG=1,ACKNumber=x+1**，SYN/ACK包本身又有一个随机序号**seq=y**此时服务器进入**SYN_RECV**状态；
第三次握手：最后，客户端再发送一个**ACK**。此时包的序号**seq被设定为x+1**，而ACK确认码则为**ACKFLAG=1,ACKNumber=y+1**。当服务端收到这个ACK的时候，客户端和服务器进入ESTABLISHED状态，完成了三次握手，客户端与服务器开始传送数据。

#### 四次挥手关闭连接
![tcp四次挥手](/images/tcp_close.png)
连接终止使用了四次挥手过程（four-way handshake），在这个过程中连接的**每一侧都独立地被终止**。当一个端点要停止它这一侧的连接，就向对侧发送FIN，对侧回复ACK表示确认。因此，拆掉一侧的连接过程需要一对FIN和ACK，分别由两侧端点发出。
1. 客户端进程发出连接释放报文，并且停止发送数据。释放数据报文首部，FIN=1，其序列号为seq=u（等于前面已经传送过来的数据的最后一个字节的序号加1），此时，客户端进入FIN-WAIT-1（终止等待1）状态。 TCP规定，FIN报文段即使不携带数据，也要消耗一个序号。
2. 服务器收到连接释放报文，发出确认报文，ACK=1，ack=u+1，并且带上自己的序列号seq=v，此时，服务端就进入了CLOSE-WAIT（关闭等待）状态。TCP服务器通知高层的应用进程，客户端向服务器的方向就释放了，这时候处于半关闭状态，即客户端已经没有数据要发送了，但是服务器若发送数据，客户端依然要接受。这个状态还要持续一段时间，也就是整个CLOSE-WAIT状态持续的时间。
3. 客户端收到服务器的确认请求后，此时，客户端就进入FIN-WAIT-2（终止等待2）状态，等待服务器发送连接释放报文（在这之前还需要接受服务器发送的最后的数据）。
4. 服务器将最后的数据发送完毕后，就向客户端发送连接释放报文，FIN=1，ack=u+1，由于在半关闭状态，服务器很可能又发送了一些数据，假定此时的序列号为seq=w，此时，服务器就进入了LAST-ACK（最后确认）状态，等待客户端的确认。
5. 客户端收到服务器的连接释放报文后，必须发出确认，ACK=1，ack=w+1，而自己的序列号是seq=u+1，此时，客户端就进入了TIME-WAIT（时间等待）状态。注意此时TCP连接还没有释放，必须经过2∗∗MSL（最长报文段寿命）的时间后，当客户端撤销相应的TCB后，才进入CLOSED状态。
6. 服务器只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB后，就结束了这次的TCP连接。可以看到，服务器结束TCP连接的时间要比客户端早一些。



## 参考文献：
[TCP的三次握手与四次挥手理解及面试题](https://blog.csdn.net/qq_38950316/article/details/81087809)
[传输控制协议 wiki](https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE)




